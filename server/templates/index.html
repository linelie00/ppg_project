<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PPG Data Processing</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
</head>
<body>
    <h1>PPG Data Processing</h1>
    <button onclick="connectMQTT()">Connect MQTT</button>
    <canvas id="ppgChart" width="400" height="200"></canvas>
    <p id="heartRate"></p>
    <p>Total received data count: <span id="totalDataCount">0</span></p>
    <p>Last 5 PPG values: <span id="lastPPGValues"></span></p>

    <script>
        const socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);

        let mqttClient;
        function connectMQTT() {
            mqttClient = mqtt.connect('wss://broker.hivemq.com:8000/mqtt');

            mqttClient.on('connect', function () {
                console.log('MQTT connected');
                mqttClient.subscribe('alert');
            });

            mqttClient.on('message', function (topic, message) {
                console.log('Message received:', message.toString());
                sendDataToServer(message.toString());
            });
        }

        function sendDataToServer(data) {
            axios.post('/process_ppg', { filtered: JSON.parse(data) })
                .then(response => {
                    const data = response.data;
                    displayChart(data.ts, data.filtered, data.peaks);
                    displayHeartRate(data.heart_rate);
                    updateDataInfo(data.total_count, data.last_ppg_values);
                })
                .catch(error => {
                    console.error('Error processing PPG data:', error);
                });
        }

        function displayChart(ts, filtered, peaks) {
            const ctx = document.getElementById('ppgChart').getContext('2d');
            if (window.ppgChart) {
                window.ppgChart.destroy();
            }
            window.ppgChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ts,
                    datasets: [{
                        label: 'Filtered PPG',
                        data: filtered,
                        borderColor: 'blue',
                        fill: false,
                        pointRadius: 0
                    }, {
                        label: 'PPG Peaks',
                        data: peaks.map(index => ({x: ts[index], y: filtered[index]})),
                        type: 'scatter',
                        backgroundColor: 'green',
                        pointRadius: 5
                    }]
                },
                options: {
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function displayHeartRate(heartRate) {
            const heartRateElement = document.getElementById('heartRate');
            heartRateElement.textContent = heartRate.length ? `Heart rate: ${heartRate[0].toFixed(2)} BPM` : 'Not enough peaks to compute heart rate.';
        }

        function updateDataInfo(totalCount, lastPPGValues) {
            const totalDataCountElement = document.getElementById('totalDataCount');
            totalDataCountElement.textContent = totalCount;

            const lastPPGValuesElement = document.getElementById('lastPPGValues');
            lastPPGValuesElement.textContent = lastPPGValues.join(', ');
        }
    </script>
</body>
</html>